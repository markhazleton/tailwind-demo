name: Performance Testing with Lighthouse CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]
    workflow_dispatch:
        inputs:
            performance_budget:
                description: "Strict performance budget enforcement"
                required: false
                default: true
                type: boolean

env:
    NODE_VERSION: "22"

jobs:
    lighthouse-ci:
        name: Lighthouse CI Performance Testing
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Install Chrome dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y xvfb

            - name: Start Xvfb
              run: |
                  Xvfb :99 -screen 0 1280x1024x24 &
                  sleep 3

            - name: Build application
              run: npm run build
              env:
                  NODE_ENV: production

            - name: Install Lighthouse CI
              run: npm install -g @lhci/cli@0.12.x

            - name: Run Lighthouse CI
              run: lhci autorun
              env:
                  DISPLAY: :99
                  LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
                  LHCI_TOKEN: ${{ secrets.LHCI_TOKEN }}

            - name: Upload Lighthouse results
              uses: actions/upload-artifact@v5
              if: always()
              with:
                  name: lighthouse-results
                  path: .lighthouseci/
                  retention-days: 30

            - name: Comment PR with Lighthouse results
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v8
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      try {
                        const resultsPath = '.lighthouseci/';
                        if (fs.existsSync(resultsPath)) {
                          const files = fs.readdirSync(resultsPath);
                          const manifestFile = files.find(f => f.endsWith('manifest.json'));
                          
                          if (manifestFile) {
                            const manifest = JSON.parse(fs.readFileSync(path.join(resultsPath, manifestFile), 'utf8'));
                            const summary = manifest.reduce((acc, result) => {
                              const scores = result.summary;
                              acc.performance += scores.performance || 0;
                              acc.accessibility += scores.accessibility || 0;
                              acc.seo += scores.seo || 0;
                              acc.bestPractices += scores['best-practices'] || 0;
                              acc.count++;
                              return acc;
                            }, { performance: 0, accessibility: 0, seo: 0, bestPractices: 0, count: 0 });

                            const avgScores = {
                              performance: Math.round((summary.performance / summary.count) * 100),
                              accessibility: Math.round((summary.accessibility / summary.count) * 100),
                              seo: Math.round((summary.seo / summary.count) * 100),
                              bestPractices: Math.round((summary.bestPractices / summary.count) * 100)
                            };

                            const getScoreEmoji = (score) => {
                              if (score >= 90) return 'ðŸŸ¢';
                              if (score >= 50) return 'ðŸŸ¡';
                              return 'ðŸ”´';
                            };

                            const comment = `## ðŸ” Lighthouse CI Performance Report

                      | Metric | Score | Status |
                      |--------|-------|--------|
                      | Performance | ${avgScores.performance}% | ${getScoreEmoji(avgScores.performance)} |
                      | Accessibility | ${avgScores.accessibility}% | ${getScoreEmoji(avgScores.accessibility)} |
                      | SEO | ${avgScores.seo}% | ${getScoreEmoji(avgScores.seo)} |
                      | Best Practices | ${avgScores.bestPractices}% | ${getScoreEmoji(avgScores.bestPractices)} |

                      ### Performance Budget Status
                      ${avgScores.performance >= 90 ? 'âœ… Performance budget PASSED' : 'âŒ Performance budget FAILED'}

                      **Note**: These scores are averaged across all tested pages. View detailed results in the artifacts.
                      `;

                            github.rest.issues.createComment({
                              issue_number: context.issue.number,
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              body: comment
                            });
                          }
                        }
                      } catch (error) {
                        console.error('Error processing Lighthouse results:', error);
                      }

    performance-regression-check:
        name: Performance Regression Detection
        runs-on: ubuntu-latest
        needs: lighthouse-ci
        if: github.event_name == 'pull_request'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download Lighthouse results
              uses: actions/download-artifact@v6
              with:
                  name: lighthouse-results
                  path: .lighthouseci/

            - name: Check for performance regressions
              uses: actions/github-script@v8
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      // Performance thresholds
                      const PERFORMANCE_THRESHOLDS = {
                        performance: 85,
                        accessibility: 95,
                        seo: 90,
                        bestPractices: 85,
                        firstContentfulPaint: 2000,
                        largestContentfulPaint: 2500,
                        speedIndex: 3000,
                        cumulativeLayoutShift: 0.1,
                        totalBlockingTime: 300
                      };

                      try {
                        const resultsPath = '.lighthouseci/';
                        if (fs.existsSync(resultsPath)) {
                          const files = fs.readdirSync(resultsPath);
                          const manifestFile = files.find(f => f.endsWith('manifest.json'));
                          
                          if (manifestFile) {
                            const manifest = JSON.parse(fs.readFileSync(path.join(resultsPath, manifestFile), 'utf8'));
                            const regressions = [];
                            
                            manifest.forEach(result => {
                              const url = result.url;
                              const scores = result.summary;
                              const audits = result.jsonPath ? JSON.parse(fs.readFileSync(result.jsonPath, 'utf8')).audits : {};

                              // Check Lighthouse scores
                              Object.entries(PERFORMANCE_THRESHOLDS).forEach(([metric, threshold]) => {
                                let actualValue;
                                let metricName = metric;
                                
                                if (metric === 'performance' || metric === 'accessibility' || metric === 'seo' || metric === 'bestPractices') {
                                  actualValue = Math.round((scores[metric === 'bestPractices' ? 'best-practices' : metric] || 0) * 100);
                                  if (actualValue < threshold) {
                                    regressions.push(`${metricName}: ${actualValue}% (threshold: ${threshold}%) on ${url}`);
                                  }
                                } else {
                                  // Performance metrics from audits
                                  const auditMap = {
                                    firstContentfulPaint: 'first-contentful-paint',
                                    largestContentfulPaint: 'largest-contentful-paint',
                                    speedIndex: 'speed-index',
                                    cumulativeLayoutShift: 'cumulative-layout-shift',
                                    totalBlockingTime: 'total-blocking-time'
                                  };
                                  
                                  const auditKey = auditMap[metric];
                                  if (audits[auditKey]) {
                                    actualValue = audits[auditKey].numericValue;
                                    
                                    if (metric === 'cumulativeLayoutShift') {
                                      if (actualValue > threshold) {
                                        regressions.push(`${metricName}: ${actualValue.toFixed(3)} (threshold: ${threshold}) on ${url}`);
                                      }
                                    } else {
                                      if (actualValue > threshold) {
                                        regressions.push(`${metricName}: ${Math.round(actualValue)}ms (threshold: ${threshold}ms) on ${url}`);
                                      }
                                    }
                                  }
                                }
                              });
                            });

                            if (regressions.length > 0) {
                              const failComment = `## âŒ Performance Regression Detected!

                      The following metrics failed to meet performance thresholds:

                      ${regressions.map(r => `- ${r}`).join('\n')}

                      ### Recommended Actions:
                      - Review bundle size and optimize lazy loading
                      - Check for memory leaks or inefficient re-renders
                      - Optimize images and other static assets
                      - Consider code splitting for large components

                      **Performance budget enforcement is ${github.event.inputs?.performance_budget === 'true' ? 'STRICT' : 'RELAXED'}**
                      `;

                              github.rest.issues.createComment({
                                issue_number: context.issue.number,
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                body: failComment
                              });

                              if (github.event.inputs?.performance_budget === 'true') {
                                core.setFailed('Performance regression detected! Check the comments for details.');
                              }
                            } else {
                              const passComment = `## âœ… Performance Check Passed!

                      All performance metrics meet the required thresholds. Great work! ðŸŽ‰

                      ### Performance Thresholds Met:
                      - Performance Score: â‰¥${PERFORMANCE_THRESHOLDS.performance}%
                      - Accessibility Score: â‰¥${PERFORMANCE_THRESHOLDS.accessibility}%
                      - SEO Score: â‰¥${PERFORMANCE_THRESHOLDS.seo}%
                      - Best Practices Score: â‰¥${PERFORMANCE_THRESHOLDS.bestPractices}%
                      - First Contentful Paint: â‰¤${PERFORMANCE_THRESHOLDS.firstContentfulPaint}ms
                      - Largest Contentful Paint: â‰¤${PERFORMANCE_THRESHOLDS.largestContentfulPaint}ms
                      - Speed Index: â‰¤${PERFORMANCE_THRESHOLDS.speedIndex}ms
                      - Cumulative Layout Shift: â‰¤${PERFORMANCE_THRESHOLDS.cumulativeLayoutShift}
                      - Total Blocking Time: â‰¤${PERFORMANCE_THRESHOLDS.totalBlockingTime}ms
                      `;

                              github.rest.issues.createComment({
                                issue_number: context.issue.number,
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                body: passComment
                              });
                            }
                          }
                        }
                      } catch (error) {
                        console.error('Error checking performance regressions:', error);
                        core.setFailed(`Performance regression check failed: ${error.message}`);
                      }
