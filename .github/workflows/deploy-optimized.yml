name: Deploy to GitHub Pages with CDN Optimization

on:
    push:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: "pages"
    cancel-in-progress: false

env:
    NODE_VERSION: "18"

jobs:
    build-and-deploy:
        name: Build and Deploy with CDN Optimization
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build application with CDN optimization
              run: npm run build:deploy
              env:
                  NODE_ENV: production
                  VITE_BASE_URL: /tailwind-demo/
                  VITE_CDN_OPTIMIZATION: true

            - name: Setup Pages
              uses: actions/configure-pages@v5

            - name: Optimize assets for CDN delivery
              run: |
                  # Create optimized directory structure
                  cd apps/demo-app/dist

                  # Add cache headers configuration for GitHub Pages
                  cat > _headers << 'EOF'
                  # Cache static assets aggressively
                  /assets/*
                    Cache-Control: public, max-age=31536000, immutable
                    X-Content-Type-Options: nosniff
                    X-Frame-Options: DENY
                    X-XSS-Protection: 1; mode=block
                    Referrer-Policy: strict-origin-when-cross-origin

                  # Cache images with long expiration
                  *.png
                    Cache-Control: public, max-age=31536000, immutable
                  *.jpg
                    Cache-Control: public, max-age=31536000, immutable
                  *.jpeg
                    Cache-Control: public, max-age=31536000, immutable
                  *.gif
                    Cache-Control: public, max-age=31536000, immutable
                  *.svg
                    Cache-Control: public, max-age=31536000, immutable
                  *.webp
                    Cache-Control: public, max-age=31536000, immutable
                  *.ico
                    Cache-Control: public, max-age=86400

                  # Cache fonts
                  *.woff
                    Cache-Control: public, max-age=31536000, immutable
                  *.woff2
                    Cache-Control: public, max-age=31536000, immutable

                  # HTML with shorter cache for dynamic content
                  *.html
                    Cache-Control: public, max-age=3600
                    X-Content-Type-Options: nosniff
                    X-Frame-Options: DENY
                    X-XSS-Protection: 1; mode=block
                    Referrer-Policy: strict-origin-when-cross-origin

                  # Service worker - no cache
                  /sw.js
                    Cache-Control: no-cache, no-store, must-revalidate

                  # Manifest and other config files
                  *.json
                    Cache-Control: public, max-age=86400
                  *.xml
                    Cache-Control: public, max-age=86400
                  *.txt
                    Cache-Control: public, max-age=86400
                  EOF

                  # Add security headers for enhanced CDN delivery
                  cat > .htaccess << 'EOF'
                  # Security headers
                  <IfModule mod_headers.c>
                    Header always set X-Content-Type-Options nosniff
                    Header always set X-Frame-Options DENY
                    Header always set X-XSS-Protection "1; mode=block"
                    Header always set Referrer-Policy "strict-origin-when-cross-origin"
                    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
                  </IfModule>

                  # Compression
                  <IfModule mod_deflate.c>
                    AddOutputFilterByType DEFLATE text/plain
                    AddOutputFilterByType DEFLATE text/html
                    AddOutputFilterByType DEFLATE text/xml
                    AddOutputFilterByType DEFLATE text/css
                    AddOutputFilterByType DEFLATE application/xml
                    AddOutputFilterByType DEFLATE application/xhtml+xml
                    AddOutputFilterByType DEFLATE application/rss+xml
                    AddOutputFilterByType DEFLATE application/javascript
                    AddOutputFilterByType DEFLATE application/x-javascript
                    AddOutputFilterByType DEFLATE application/json
                  </IfModule>

                  # Browser caching for static assets
                  <IfModule mod_expires.c>
                    ExpiresActive on
                    ExpiresByType text/css "access plus 1 year"
                    ExpiresByType application/javascript "access plus 1 year"
                    ExpiresByType text/javascript "access plus 1 year"
                    ExpiresByType image/png "access plus 1 year"
                    ExpiresByType image/jpg "access plus 1 year"
                    ExpiresByType image/jpeg "access plus 1 year"
                    ExpiresByType image/gif "access plus 1 year"
                    ExpiresByType image/svg+xml "access plus 1 year"
                    ExpiresByType image/webp "access plus 1 year"
                    ExpiresByType application/pdf "access plus 1 month"
                    ExpiresByType text/x-javascript "access plus 1 year"
                    ExpiresByType application/x-shockwave-flash "access plus 1 year"
                    ExpiresByType image/x-icon "access plus 1 year"
                    ExpiresByType text/html "access plus 1 hour"
                  </IfModule>
                  EOF

            - name: Generate sitemap with CDN optimization
              run: |
                  cd apps/demo-app/dist

                  # Create optimized sitemap
                  cat > sitemap.xml << 'EOF'
                  <?xml version="1.0" encoding="UTF-8"?>
                  <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
                          xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">
                    <url>
                      <loc>https://markhazleton.github.io/tailwind-demo/</loc>
                      <lastmod>$(date -u +%Y-%m-%dT%H:%M:%S+00:00)</lastmod>
                      <changefreq>weekly</changefreq>
                      <priority>1.0</priority>
                    </url>
                    <url>
                      <loc>https://markhazleton.github.io/tailwind-demo/dashboard</loc>
                      <lastmod>$(date -u +%Y-%m-%dT%H:%M:%S+00:00)</lastmod>
                      <changefreq>weekly</changefreq>
                      <priority>0.8</priority>
                    </url>
                    <url>
                      <loc>https://markhazleton.github.io/tailwind-demo/design-system</loc>
                      <lastmod>$(date -u +%Y-%m-%dT%H:%M:%S+00:00)</lastmod>
                      <changefreq>weekly</changefreq>
                      <priority>0.9</priority>
                    </url>
                    <url>
                      <loc>https://markhazleton.github.io/tailwind-demo/demos</loc>
                      <lastmod>$(date -u +%Y-%m-%dT%H:%M:%S+00:00)</lastmod>
                      <changefreq>weekly</changefreq>
                      <priority>0.8</priority>
                    </url>
                    <url>
                      <loc>https://markhazleton.github.io/tailwind-demo/marketing</loc>
                      <lastmod>$(date -u +%Y-%m-%dT%H:%M:%S+00:00)</lastmod>
                      <changefreq>weekly</changefreq>
                      <priority>0.7</priority>
                    </url>
                    <url>
                      <loc>https://markhazleton.github.io/tailwind-demo/ecommerce</loc>
                      <lastmod>$(date -u +%Y-%m-%dT%H:%M:%S+00:00)</lastmod>
                      <changefreq>weekly</changefreq>
                      <priority>0.7</priority>
                    </url>
                    <url>
                      <loc>https://markhazleton.github.io/tailwind-demo/animations</loc>
                      <lastmod>$(date -u +%Y-%m-%dT%H:%M:%S+00:00)</lastmod>
                      <changefreq>weekly</changefreq>
                      <priority>0.6</priority>
                    </url>
                  </urlset>
                  EOF

            - name: Create robots.txt with CDN-friendly settings
              run: |
                  cd apps/demo-app/dist

                  cat > robots.txt << 'EOF'
                  User-agent: *
                  Allow: /

                  # Sitemap location
                  Sitemap: https://markhazleton.github.io/tailwind-demo/sitemap.xml

                  # Crawl-delay for respectful crawling
                  Crawl-delay: 1

                  # Disallow service worker and other technical files
                  Disallow: /sw.js
                  Disallow: /.well-known/
                  Disallow: /assets/*.map

                  # Allow CDN optimization files
                  Allow: /assets/
                  Allow: /*.css
                  Allow: /*.js
                  Allow: /*.png
                  Allow: /*.jpg
                  Allow: /*.jpeg
                  Allow: /*.gif
                  Allow: /*.svg
                  Allow: /*.webp
                  EOF

            - name: Upload artifact for Pages
              uses: actions/upload-pages-artifact@v3
              with:
                  path: apps/demo-app/dist

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

            - name: Update deployment status
              if: always()
              run: |
                  echo "::notice title=Deployment Status::Deployment completed with CDN optimization"
                  echo "::notice title=Website URL::https://markhazleton.github.io/tailwind-demo/"
                  echo "::notice title=Cache Strategy::Static assets cached for 1 year, HTML cached for 1 hour"
